<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ğŸ”§ Laporan Service â€” Aplikasiku</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007bff">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f0f2f5;margin:0;padding:20px}
    h2{text-align:center}
    form{background:#fff;padding:18px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);max-width:440px;margin:0 auto}
    input,textarea,select,button{width:100%;margin:6px 0;padding:10px;border-radius:6px;border:1px solid #ccc}
    button{background:#007bff;color:#fff;border:0;cursor:pointer}
    button:hover{background:#0056b3}
    #dataList{margin:25px auto;max-width:1000px;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);padding:15px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #ddd;text-align:left}
    th{background:#007bff;color:#fff}
    .btn{cursor:pointer;padding:5px 8px;border-radius:5px;font-size:13px;margin:0 2px}
    .edit{background:#ffc107;color:#000}
    .delete{background:#dc3545;color:#fff}
    .msg{text-align:center;margin:10px;color:#0b7a1f}
    .error{color:#c00}
  </style>
</head>
<body>
  <h2>ğŸ”§ Laporan Service</h2>

  <form id="serviceForm" autocomplete="off">
    <input name="nama" id="nama" placeholder="Nama Pelanggan" required>
    <input name="kontak" id="kontak" placeholder="Nomor Kontak" required>
    <input name="barang" id="barang" placeholder="Nama Barang" required>
    <textarea name="kerusakan" id="kerusakan" placeholder="Kerusakan" required></textarea>
    <input name="tanggal" id="tanggal" type="date" required>
    <input name="teknisi" id="teknisi" placeholder="Nama Teknisi" required>
    <input name="biaya" id="biaya" placeholder="Biaya Service" required>
    <select name="status" id="status" required>
      <option value="">Pilih Status</option>
      <option value="Proses">Proses</option>
      <option value="Selesai">Selesai</option>
      <option value="Diambil">Diambil</option>
    </select>
    <input type="hidden" id="editIndex">
    <button type="submit">Simpan</button>
  </form>

  <div class="msg" id="msgBox"></div>

  <div id="dataList">
    <h3>ğŸ“‹ Daftar Service</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>#</th><th>Nama</th><th>Kontak</th><th>Barang</th><th>Kerusakan</th>
          <th>Tanggal</th><th>Teknisi</th><th>Biaya</th><th>Status</th><th>Aksi</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxkRNinHmmINZi4TVw894seHBMEdI1ceDQAwUTDhB3xyEKYcI_PBtoW6EhxzlIDTe_T/exec";
const LOCAL_KEY = "serviceData_v2";
const form = document.getElementById('serviceForm');
const msg = document.getElementById('msgBox');
const tbody = document.querySelector('#dataTable tbody');
let dataLocal = [];

function showMsg(t, err=false){msg.textContent=t;msg.className=err?'msg error':'msg';setTimeout(()=>msg.textContent="",5000);}
function saveLocal(){localStorage.setItem(LOCAL_KEY, JSON.stringify(dataLocal));}
function loadLocal(){dataLocal = JSON.parse(localStorage.getItem(LOCAL_KEY)||'[]');render();}
function render(){
  tbody.innerHTML='';
  dataLocal.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
    <td>${i+1}</td>
    <td>${r.nama}</td>
    <td>${r.kontak}</td>
    <td>${r.barang}</td>
    <td>${r.kerusakan}</td>
    <td>${r.tanggal}</td>
    <td>${r.teknisi}</td>
    <td>${r.biaya}</td>
    <td>${r.status}</td>
    <td>
      <button class="btn edit" onclick="editRow(${i})">âœï¸</button>
      <button class="btn delete" onclick="deleteRow(${i})">ğŸ—‘ï¸</button>
    </td>`;
    tbody.appendChild(tr);
  });
}

function editRow(i){
  const r=dataLocal[i];
  for(let k in r){if(form[k]) form[k].value=r[k];}
  document.getElementById('editIndex').value=i;
  showMsg('Mode edit data baris '+(i+1));
}

function deleteRow(i){
  if(!confirm('Yakin hapus data ini?'))return;
  const row=dataLocal[i];
  dataLocal.splice(i,1);
  saveLocal();render();
  // kirim hapus ke spreadsheet
  fetch(scriptURL+"?action=delete&id="+(row.id||""),{method:'GET'}).catch(console.error);
  showMsg('Data dihapus.');
}

form.addEventListener('submit',e=>{
  e.preventDefault();
  const data = {
  token: "mhmd12345", // sama seperti di Code.gs
  action: "add",
  nama: form.nama.value,
  kontak: form.kontak.value,
  barang: form.barang.value,
  kerusakan: form.kerusakan.value,
  tanggal: form.tanggal.value,
  teknisi: form.teknisi.value,
  biaya: form.biaya.value,
  status: form.status.value
};
  const editIndex=form.editIndex.value;
  if(editIndex){
    dataLocal[editIndex]={...dataLocal[editIndex],...data};
    saveLocal();render();
    showMsg('Data lokal diperbarui.');
    // kirim update ke spreadsheet
    fetch(scriptURL+"?action=update&id="+(dataLocal[editIndex].id||""),{
      method:'POST',
      body:JSON.stringify(data),
      headers:{'Content-Type':'application/json'}
    });
  }else{
    dataLocal.unshift(data);
    saveLocal();render();
    showMsg('Data disimpan lokal & dikirim...');
    // kirim tambah ke spreadsheet
    fetch(scriptURL, {
  method: 'POST',
  body: JSON.stringify(data),
  headers: { 'Content-Type': 'text/plain;charset=utf-8' }
})
    .then(r=>r.json())
    .then(res=>{
      if(res.id){data.id=res.id;saveLocal();}
      showMsg(res.message||'Terkirim');
    }).catch(err=>showMsg('Gagal kirim',true));
  }
  form.reset();form.editIndex.value='';
});

loadLocal();

// Ambil data awal dari spreadsheet
fetch(scriptURL+"?read=true").then(r=>r.json()).then(rows=>{
  if(Array.isArray(rows)){
    rows.forEach(r=>{if(!r.id)r.id='';});
    dataLocal=rows.reverse();
    saveLocal();render();
  }
});
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("âœ… Service Worker aktif"))
    .catch(err => console.log("âŒ Gagal daftar Service Worker:", err));
}
</script>
</body>
</html>
